# 小魔仙RAG智能体功能迭代历史

## 版本 1.0.0 - 初始版本 (2024-12-29)

### 核心功能
- [x] Obsidian 笔记连接器
- [x] 向量数据库（ChromaDB）集成
- [x] Ollama 模型支持
- [x] 文档分块和索引功能
- [x] RAG 检索和问答功能
- [x] 命令行交互界面

### 技术特性
- [x] uv 依赖管理
- [x] Makefile 自动化构建
- [x] 代码质量检查（Ruff）
- [x] 测试套件

---

## 版本 1.1.0 - 环境优化 (2024-12-29)

### 新增功能
- [x] 小魔仙模型（bge-m3:latest）支持
- [x] API 嵌入模式支持
- [x] 环境变量配置优化

### 修复问题
- [x] 修复 NumPy 2.0 兼容性问题
- [x] 修复相对导入问题
- [x] 优化错误处理机制

---

## 版本 1.2.0 - 项目结构优化 (2025-01-01)

### 结构调整
- [x] 创建 tests/ 目录统一存放测试文件
- [x] 创建 scripts/ 目录统一存放脚本文件
- [x] 创建 docs/ 目录统一存放文档
- [x] 创建 roadmap/ 目录统一存放产品路标文档
- [x] 更新 .gitignore 忽略向量数据库目录

### 自动化改进
- [x] 优化 Makefile 命令
- [x] 更新启动脚本使用 uv 管理依赖

---

## 版本 1.3.0 - 智能回答增强 (2025-01-01)

### 新增功能
- [x] 当未找到相关文档时使用本地大模型回答
- [x] 改进用户提示体验
- [x] 增强系统健壮性

### 技术改进
- [x] 在 retriever.py 中添加 LLM 回答功能
- [x] 优化错误处理和日志记录
- [x] 保持与现有系统的兼容性

---

## 版本 1.4.0 - 提示词管理重构 (2025-01-01)

### 重构改进
- [x] 创建 prompts/ 目录统一管理提示词
- [x] 将硬编码提示词提取到独立模块
- [x] 按功能分类管理提示词模板
- [x] 提高提示词的可维护性

### 技术改进
- [x] 创建 prompt_templates.py 统一管理模板
- [x] 更新 retriever.py 使用提示词模板
- [x] 更新 prompt_engineer.py 使用提示词模板
- [x] 保持向后兼容性

---

## 版本 1.5.0 - RAG提示词优化 (2025-01-01)

### 修复改进
- [x] 改进RAG提示词模板，更好地处理检索到的文档内容
- [x] 优化文档相关性判断逻辑
- [x] 提高回答准确性

### 技术改进
- [x] 更新rag_answer模板，优先使用检索到的相关信息
- [x] 改进提示词指导，更好地结合检索内容和通用知识

---

## V1.6.0 - 高级意图理解功能版本

### 更新说明
- **日期**: 2025-12-30
- **版本**: v1.6.0
- **主要改进**: 基于业界最佳实践实现高级意图理解能力，包含查询分类、历史对话感知的查询重写、结构化意图解析等功能

### 具体变更
1. **IntentRecognizer类重构**:
   - 实现查询分类功能，将用户输入分为chitchat、knowledge_query、tool_request、ambiguous四类
   - 实现历史对话感知的查询重写功能，结合最近3轮对话历史重写查询
   - 实现结构化意图解析，解析出intent、entity、aspect和confidence
   - 添加意图识别准确性保障机制，当confidence<0.7时返回澄清消息

2. **高级意图理解**:
   - 实现轻量级零样本分类，不依赖训练数据
   - 支持JSON Schema格式的结构化输出
   - 实现查询重写功能，将指代性查询转换为独立查询

3. **查询处理优化**:
   - 实现置信度检查机制
   - 添加澄清响应功能
   - 优化历史对话查询处理

### 解决的问题
- 提升了意图识别的准确性
- 增强了多轮对话中的指代消解能力
- 改善了用户查询的处理精度
- 实现了业界标准的意图理解能力

## V1.5.0 - 意图识别优化版本

### 更新说明
- **日期**: 2025-12-30
- **版本**: v1.5.0
- **主要改进**: 基于aidev项目实现方式优化用户意图识别，增强历史对话查询处理能力

### 具体变更
1. **IntentRecognizer类改进**:
   - 添加history_query意图类型，专门处理历史对话查询
   - 实现_query_rewrite_for_independence方法，支持将用户查询重写为独立查询
   - 优化意图识别逻辑，参考aidev项目的实现方式
   - 添加_query_classification_prompt构建方法，支持查询类型分类

2. **意图识别增强**:
   - 实现专门的_history_query识别方法
   - 改进意图识别准确性
   - 支持基于历史上下文的意图判断

3. **查询分类与重写**:
   - 实现classify_query_type方法，支持新查询、继续对话、结束对话分类
   - 实现基于LLM的查询重写功能
   - 添加规则基础的查询分类作为备选

### 解决的问题
- 提升了对历史对话查询的识别准确性
- 增强了多轮对话中的上下文理解能力
- 改善了用户查询的处理精度

## V1.4.0 - 对话历史上下文理解优化版本

### 更新说明
- **日期**: 2025-12-30
- **版本**: v1.4.0
- **主要改进**: 优化小魔仙RAG智能体的对话历史上下文理解功能，增加对历史查询的智能处理能力

### 具体变更
1. **RAGAgent类改进**:
   - 添加_is_history_query方法，用于识别涉及历史对话的查询
   - 添加_handle_history_query方法，专门处理对历史对话的查询
   - 支持识别多种历史查询模式（第一个问题、之前的问题、对话历史等）
   - 优化历史记录的访问和展示逻辑

2. **历史查询处理**:
   - 支持查询第一个问题
   - 支持查询最近的对话记录
   - 支持查询历史中的特定问题
   - 提供友好的历史对话展示格式

### 解决的问题
- 系统现在能够正确处理关于历史对话的问题
- 提升了多轮对话中上下文理解的准确性
- 改善了用户查询历史记录的体验

## V1.3.0 - 对话历史上下文理解功能版本

### 更新说明
- **日期**: 2025-12-30
- **版本**: v1.3.0
- **主要改进**: 为小魔仙RAG智能体添加对话历史上下文理解功能，支持多轮对话中的上下文关联

### 具体变更
1. **RAGAgent类改进**:
   - 添加chat_history属性用于存储对话历史
   - 在query方法中支持传递对话历史给意图识别器
   - 实现对话历史的自动管理（添加、限制长度）
   - 在CLI界面中支持对话历史功能

2. **对话历史管理**:
   - 自动记录用户查询和系统响应
   - 限制对话历史长度以优化性能
   - 添加清空对话历史的功能

3. **意图识别增强**:
   - 意图识别器现在可以利用对话历史进行上下文理解
   - 支持基于历史上下文的意图判断

### 解决的问题
- 实现了多轮对话中的上下文理解
- 支持指代消解和上下文相关的查询处理
- 提升了对话的连贯性和自然性

## V1.2.0 - 意图识别功能版本

### 更新说明
- **日期**: 2025-12-30
- **版本**: v1.2.0
- **主要改进**: 为小魔仙RAG智能体添加用户意图识别系统，提升对话理解和响应准确性

### 具体变更
1. **新增IntentRecognizer类**:
   - 实现基于关键词匹配的意图识别
   - 实现基于LLM的意图识别
   - 提供意图类型分类功能
   - 支持对话历史上下文理解

2. **意图类型定义**:
   - general_query: 一般性知识查询
   - specific_info: 特定信息查询
   - clarification: 需要澄清或选择的查询
   - follow_up: 跟进或补充性问题
   - chit_chat: 闲聊或礼貌性回复

3. **集成到RAGAgent**:
   - 在query方法中集成意图识别逻辑
   - 根据意图类型选择不同处理策略
   - 对闲聊类意图直接使用通用模型回答

### 解决的问题
- 提高了系统对用户查询意图的理解准确性
- 减少了无关文档的检索和处理
- 优化了闲聊类查询的响应效率
- 增强了对话的自然性和流畅性

## V1.1.0 - 检索相关性优化版本

### 更新说明
- **日期**: 2025-12-29
- **版本**: v1.1.0
- **主要改进**: 解决了检索器相关性判断问题，当没有找到相关文档时直接使用本地大模型回答，避免将不相关的文档片段传递给模型

### 具体变更
1. **Retriever 类改进**:
   - 添加了 `retrieve_and_filter_by_similarity` 方法，返回过滤后的结果和相关性标志
   - 添加了 `format_results` 方法，分离格式化逻辑
   - 实现了基于相似度阈值的文档过滤

2. **RAGAgent 类改进**:
   - 修改了 `query` 方法，根据是否有相关文档选择不同的处理逻辑
   - 当没有相关文档时，直接使用 `no_document_found` 提示词模板

3. **配置改进**:
   - 保持 `SIMILARITY_THRESHOLD` 配置项，可配置的相似度阈值

### 解决的问题
- 修复了即使没有找到相关文档也显示有文档片段的问题
- 修复了将不相关文档传递给模型导致错误回答的问题
- 提高了用户体验，当知识库中没有相关信息时能给出更自然的回答

## 迭代 1.5 - 幻觉检测与检索优化 (2026年1月)

### 完成的功能
- **幻觉检测与预防机制**
  - 实现了基于事实对比的检测机制
  - 实现了基于语义一致性的检测机制
  - 集成双重检测机制到主查询流程
  - 配置生成参数（temperature=0.2, top_p=0.8, top_k=30）减少随机性
  - 添加置信度评估机制

- **优化检索策略**
  - 实现自适应相似度过滤策略
  - 基于检索结果的平均相似度动态调整阈值
  - 实现多级过滤回退机制
  - 确保即使整体相似度不高但相对匹配度最高的文档也能被保留

- **提示词管理优化**
  - 合并幻觉检测和预防提示词模板
  - 提供完整的中文版本提示词模板
  - 确保所有提示词优先使用中文

- **日志输出增强**
  - 为幻觉检测模块添加详细日志输出
  - 确保所有关键方法和判断分支都有足够的日志输出
  - 提高系统可调试性

### 技术细节
- 创建了`hallucination_detector.py`模块
- 添加了`test_hallucination_detection.py`测试文件
- 优化了`retriever.py`中的过滤逻辑
- 合并了提示词模板文件

### 影响
- 显著降低RAG系统中大模型幻觉现象
- 改善检索器性能，减少将相关文档错误过滤的情况
- 提高系统可调试性

## 迭代 1.4 - 意图识别系统 (2025年12月)

### 完成的功能
- **意图识别系统**
  - 实现查询分类功能（闲聊、知识查询、工具请求、模糊需澄清）
  - 实现历史对话感知的查询重写
  - 实现结构化意图解析
  - 添加澄清响应机制

- **历史对话感知**
  - 实现指代解析和查询重写
  - 支持多轮对话上下文理解
  - 优化指代性表达替换为具体历史信息

### 技术细节
- 创建了`intent/`目录及子模块
- 实现意图识别器类
- 添加意图识别提示词模板

### 影响
- 提高查询理解准确性
- 改善多轮对话体验

## 迭代 1.3 - 提示词管理 (2025年12月)

### 完成的功能
- **提示词管理重构**
  - 将硬编码提示词从代码中分离
  - 创建独立的提示词模板文件
  - 按功能分类管理提示词

### 技术细节
- 创建了`prompts/`目录
- 实现`prompt_templates.py`文件
- 按RAG相关、系统提示词等分类管理

### 影响
- 提高代码可维护性
- 便于提示词优化和调整

## 迭代 1.2 - Ollama API 集成 (2025年12月)

### 完成的功能
- **Ollama API 集成**
  - 实现通过API使用本地模型进行嵌入计算
  - 支持多种本地模型
  - 配置小魔仙模型（bge-m3:latest）

### 技术细节
- 修改`vector_store.py`以支持API嵌入
- 添加API配置选项
- 优化模型配置管理

### 影响
- 提高嵌入计算性能
- 支持更多本地模型选项

## 迭代 1.1 - 基础 RAG 功能 (2025年12月)

### 完成的功能
- **基础 RAG 功能**
  - 实现Obsidian笔记索引到向量数据库
  - 实现基于查询的文档检索
  - 实现基于检索结果的响应生成

### 技术细节
- 创建`rag_agent/`目录
- 实现`vector_store.py`、`retriever.py`、`main.py`
- 集成ChromaDB向量数据库

### 影响
- 建立了基础RAG系统
- 实现了知识库问答功能

## 迭代 1.6 - 流式响应功能 (2026年1月)

### 完成的功能
- **流式响应处理**
  - 实现多种事件类型（LOADING、TEXT、DONE、ERROR、REFERENCE_DOC、THINK）
  - 支持Server-Sent Events (SSE)协议传输流式数据
  - 实现可视化思考过程，用户可看到AI推理过程
  - 实现错误处理机制
  - 支持内容覆盖控制和思考时间计算

- **实时传输能力**
  - 支持边生成边显示，提升用户体验
  - 实现交互控制（支持停止生成功能）
  - 通过心跳机制保持连接稳定

### 技术细节
- 创建了`streaming_handler.py`流式响应处理模块
- 实现`EventType`枚举和`StreamEvent`数据类
- 在`RAGAgent`类中添加`query_stream`异步方法
- 实现`StreamingHandler`类处理流式响应
- 创建`streaming_api.py`提供SSE端点

### 影响
- 提供透明、高效的交互体验
- 用户可以看到AI的实时思考过程和最终答案
- 提升系统可用性和用户体验

## 迭代 1.0 - 项目初始化 (2025年12月)

### 完成的功能
- **项目基础设施**
  - 配置uv依赖管理
  - 设置自动化构建工具(Makefile)
  - 配置代码质量检查(Ruff)
  - 创建基本项目结构

### 技术细节
  - `pyproject.toml`配置
  - `Makefile`自动化脚本
  - 项目目录结构

### 影响
- 建立了现代化开发环境
- 实现了自动化构建流程
